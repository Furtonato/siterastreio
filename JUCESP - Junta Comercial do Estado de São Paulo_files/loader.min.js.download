const client = document.currentScript.getAttribute('client')
    , sdk_url = new URL(document.currentScript.getAttribute('src'));

var chatbotElement = document.getElementById(`${client}-chatbots`);
if (!chatbotElement) {
    chatbotElement = document.createElement('div');
    chatbotElement.id = `${client}-chatbots`;
    chatbotElement.style = "display:none";
    document.body.appendChild(chatbotElement);
}

const theme = chatbotElement.getAttribute('theme') || document.currentScript.getAttribute('theme')
    , on_dispatch = (chatbotElement.getAttribute('on') || document.currentScript.getAttribute('on')) == 'click' ? 'click' : 'mouseover';





const cdnjs_url = 'https://cdnjs.cloudflare.com/ajax/libs'
    , jquery_version = '1.10.2';

if (typeof jQuery == 'undefined') {
    let script = document.createElement('script');
    script.src = `${cdnjs_url}/jquery/${jquery_version}/jquery.min.js`;
    document.getElementsByTagName('head')[0].appendChild(script);
}

function defer(method) {
    if (typeof jQuery !== 'undefined') {
        method();
    } else {
        setTimeout(() => defer(method), 10);
    }
}

defer(function () {


    let style = document.createElement('link');
    style.rel = 'stylesheet';
    let filename = sdk_url.href.substr(sdk_url.href.lastIndexOf('/')).replace('/', '').split('.')[0];
    style.href = `${sdk_url.href.replace(filename, filename + (theme ? `-${theme}` : '')).replace('js', 'css')}`;
    // style.onload = () => $(chatbotElement).show();
    document.getElementsByTagName('head')[0].appendChild(style);

    if (theme == 'floating-balloon') {
        $(chatbotElement).append('<div id="contentParente" class="responsive-columns-wrappers">'
                               + '  <div id = "chats-column-holder" class="responsive-column content-column boxChatIcones" >'
                               + '    <div class="chats-column">'
                               + '      <div class="headerBCss">Assistente Virtual Ju <span class="closeChat"></span></div>'
                               + '      <div id="scrollingChatsd"></div>'
                               + '      <div class ="choices" style="display:none"></div>'
                               + '        <label for="textInput" class="inputOutline">'
                               + '          <input id="textInput" autocomplete="off" class="input responsive-column" placeholder="Escreva aqui..." type="text" onkeydown="ConversationPanel.inputKeyDown(event, this)">'
                               + '          <input type="button" value="ok" class="btnSendConversation" onclick="ConversationPanel.inputClick()">'
                               + '        </label>'
                               + '      </div>'
                               + '      <figure class="thumbBt">'
                               + '         <div class="bgAjuda">Olá, em que posso ajudar?</div>'
                               + '         <div class="iconChat"></div>'
                               + '        <figcaption></figcaption>'
                               + '      </figure>'
                               + '  </div>'
                               + '</div >');
        $(window).scroll(function () {
            if ($(window).width() >= 768) {
                var bg_pos = $(window).scrollTop();
                if (bg_pos >= 295) {
                    $('.juhHome').css('top', '180px');
                } else {
                    $('.juhHome').css('top', '280px');
                }
            }
        });
    }

    if (('ontouchstart' in window || navigator.msMaxTouchPoints) && $(window).width() <= 2995) {
        $('.thumbBt .bgAjuda').hide();
    }

    if($(document.querySelector(".choices"))){}

    /**
     * API COMMNON
     */
    var Common = (function () {
        return {
            buildDomElement: buildDomElementFromJson,
            fireEvent: fireEvent,
            listForEach: listForEach
        };

        function buildDomElementFromJson(domJson) {
            var element = document.createElement(domJson.tagName);
            if (domJson.text) {
                element.innerHTML = domJson.text
            } else if (domJson.html) {
                element.insertAdjacentHTML('beforeend', domJson.html)
            }
            if (domJson.classNames) {
                for (var i = 0; i < domJson.classNames.length; i++) {
                    element.classList.add(domJson.classNames[i]);
                }
            }
            if (domJson.attributes) {
                for (var j = 0; j < domJson.attributes.length; j++) {
                    var currentAttribute = domJson.attributes[j];
                    element.setAttribute(currentAttribute.name, currentAttribute.value)
                }
            }
            if (domJson.children) {
                for (var k = 0; k < domJson.children.length; k++) {
                    var currentChild = domJson.children[k];
                    element.appendChild(buildDomElementFromJson(currentChild))
                }
            }
            return element
        }

        function fireEvent(element, event) {
            var evt;
            if (document.createEventObject) {
                evt = document.createEventObject();
                return element.fireEvent('on' + event, evt)
            }
            evt = document.createEvent('HTMLEvents');
            evt.initEvent(event, !0, !0);
            return !element.dispatchEvent(evt)
        }

        function listForEach(list, callback) {
            for (var i = 0; i < list.length; i++) {
                callback.call(null, list[i])
            }
        }
    }());

    function accounType(response) {
        $(".box-btn-inicial").hide(400);
        $(".box-btn-horario").hide(400);
        $(".box-btn-confirma").hide(400);
        $(".box-btn-servicos").hide(400);
        var res = response;
        var context;
        var latestResponse = Api.getResponsePayload();
        if (latestResponse) {
            context = latestResponse.context
        }
        Api.sendRequest(res, context)
    }

    window.accounType = accounType;

    function generateOTP(response) {
        var func = response
    }

    /**
     * (API) URL REQUEST / RESPONSE.
     */
    var Api = (function () {
        var requestPayload;
        var responsePayload;
        var serverURL = sdk_url.origin;
        //var serverURL = 'http://localhost:3000';    
        return {
            sendRequest: sendRequest,
            getRequestPayload: function () {
                return requestPayload
            },
            setRequestPayload: function (newPayloadStr) {
                requestPayload = JSON.parse(newPayloadStr)
            },
            getResponsePayload: function () {
                return responsePayload
            },
            setResponsePayload: function (newPayloadStr) {
                responsePayload = JSON.parse(newPayloadStr)
            }
        };

        function sendRequest(text, context) {
            var payloadToWatson = {};
            if (text) {
                payloadToWatson.input = {
                    text: text
                }
            }
            if (context) {
                payloadToWatson.context = context
            }
            var http = new XMLHttpRequest();
            http.open('POST', serverURL + '/api/message', true);

            http.setRequestHeader('Content-type', 'application/json');
            http.setRequestHeader('Access-Control-Allow-Origin', '*');
            http.setRequestHeader('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');

            http.onreadystatechange = function () {
                if (http.readyState === 4 && http.status === 200 && http.responseText) {
                    Api.setResponsePayload(http.responseText)
                }
            };

            var params = JSON.stringify(payloadToWatson);
            if (Object.getOwnPropertyNames(payloadToWatson).length !== 0) {
                Api.setRequestPayload(params);
            }

            http.send(params);
        }
    }());


    /**
     * API CONVERSATION.
     */
    window.ConversationPanel = (function () {
        var settings = {
            selectors: {
                chatBox: '#scrollingChatsd',
                fromUser: '.from-user',
                fromWatson: '.from-watson',
                latest: '.latest'
            },
            authorTypes: {
                user: 'user',
                watson: 'watson'
            }
        };
        return {
            init: init,
            inputKeyDown: inputKeyDown,
            inputClick: inputClick
        };

        function init() {
            chatUpdateSetup();
            Api.sendRequest('', null);
            setupInputBox()
        }

        function chatUpdateSetup() {
            var currentRequestPayloadSetter = Api.setRequestPayload;
            Api.setRequestPayload = function (newPayloadStr) {
                currentRequestPayloadSetter.call(Api, newPayloadStr);
                displayMessage(JSON.parse(newPayloadStr), settings.authorTypes.user)
            };
            var currentResponsePayloadSetter = Api.setResponsePayload;
            Api.setResponsePayload = function (newPayloadStr) {
                currentResponsePayloadSetter.call(Api, newPayloadStr);
                displayMessage(JSON.parse(newPayloadStr), settings.authorTypes.watson)
            }
        }

        function setupInputBox() {
            var input = document.getElementById('textInput');
            var dummy = document.getElementById('textInputDummy');
            var padding = 3;
            if (dummy === null) {
                var dummyJson = {
                    'tagName': 'div',
                    'attributes': [{
                        'name': 'id',
                        'value': 'textInputDummy'
                    }]
                };
                dummy = Common.buildDomElement(dummyJson);
                ['font-size', 'font-style', 'font-weight', 'font-family', 'line-height', 'text-transform', 'letter-spacing'].forEach(function (index) {
                    dummy.style[index] = window.getComputedStyle(input, null).getPropertyValue(index)
                });
                chatbotElement.appendChild(dummy);
            }
            input.addEventListener('input', function () {
                if (this.value === '') {
                    this.classList.remove('underline');
                    this.setAttribute('style', 'width:' + '100%');
                    this.style.width = '100%'
                } else {
                    this.classList.add('underline');
                    var txtNode = document.createTextNode(this.value);
                    dummy.textContent = txtNode.textContent;
                    var widthValue = (dummy.offsetWidth + padding) + 'px';
                    this.setAttribute('style', 'width:' + widthValue);
                    this.style.width = widthValue
                }
            });
            Common.fireEvent(input, 'input')
        }

        function displayMessage(newPayload, typeValue) {
            var isUser = isUserMessage(typeValue);
            var textExists = (newPayload.input && newPayload.input.text) || (newPayload.output && newPayload.output.text);
            if (isUser !== null && textExists) {
                if (newPayload.context !== undefined && newPayload.context !== null) {
                    $('div[class*=box-etapa]').hide();
                    $(".box-cancelar").hide();
                    if (!newPayload.context.etapa_confirmacao_agend) {
                        $("#scrollingChatsd").addClass("boxChoices");
                        $(".choices").show();
                        if (newPayload.context.etapa_servico === true && newPayload.context.etapa_posto === true
                            && newPayload.context.etapa_data === true
                            && newPayload.context.hasOwnProperty('isSolicitacaoAlterarEmAndamento') === false
                            && newPayload.context.hasOwnProperty('isSolicitacaoCancelarEmAndamento') === false) {
                            $(".box-etapa2").show();
                        } else if (newPayload.context.etapa_servico === true && newPayload.context.etapa_posto === true
                            && newPayload.context.hasOwnProperty('isSolicitacaoAlterarEmAndamento') === false
                            && newPayload.context.hasOwnProperty('isSolicitacaoCancelarEmAndamento') === false
                            && !newPayload.context.Postos) {
                            $(".box-etapa1").show();
                        } else if (newPayload.context.etapa_cpf && !newPayload.context.etapa_posto && newPayload.context.Alterar !== 'nome'
                            && !newPayload.context.isValidaPosto) {
                            $(".box-etapa4").show();
                            
                        }else if(newPayload.context.postocdhu === true && newPayload.context.Postos !== "" || (newPayload.context.descricaoService === "cdhu" && newPayload.context.servicoCDHU !=="")  ){
                            $(".box-cancelar").show();
                            if(newPayload.context.contarDataNasc == 0 && newPayload.context.etapa_dtNasc == false){
                                $(".box-cancelar").hide();
                                $(".box-etapa4").show();
                            }
                            if(newPayload.context.contarDataNasc == 0 && newPayload.context.agoraDataNasc == false){
                                $(".box-cancelar").hide();
                                $("box-etapa1").show();
                            }
                            // Condições com CPF 84158378109  não esta no CAR
                            if(newPayload.context.contarDataNasc == 0 && newPayload.context.agoraDataNasc == false && ["acordo","boletoAgrupado","informacoes"].includes(newPayload.context.servicoCDHU) 
                               &&  newPayload.context.etapa_cpf === true && newPayload.context.naoDataAgend === false){
                                $(".box-etapa1").show();
                             }
                             if(newPayload.context.contarDataNasc == 0 && newPayload.context.agoraDataNasc == false && ["acordo","boletoAgrupado","informacoes"].includes(newPayload.context.servicoCDHU) 
                               &&  newPayload.context.etapa_cpf === true && newPayload.context.etapa_data == true){
                                $(".box-etapa1").hide();
                                $(".box-etapa2").show();
                             }
                             // Condições com CPF 99999999999  não tem CPF
                             if(newPayload.context.descricaoService === "cdhu" && newPayload.context.agoraDataNasc == false && newPayload.context.etapa_dtNasc === true && !newPayload.context.etapa_nome === false){
                                $(".box-cancelar").hide();
                                $(".box-etapa5").show();
                             }
                             if(newPayload.context.descricaoService === "cdhu" && newPayload.context.agoraDataNasc == false && newPayload.context.etapa_dtNasc === true && !newPayload.context.etapa_nome === false && newPayload.context.etapa_data == true){
                                $(".box-etapa5").hide();
                                $(".box-etapa2").show();
                             }
                        }else if(newPayload.context.descricaoService === "cdhu" && newPayload.context.delete == true ||
                        (["acordo","boletoAgrupado","informacoes"].includes(newPayload.context.servicoCDHU) && newPayload.context.contarDataNasc == 1 
                        && newPayload.context.etapa_cpf==true && newPayload.context.date == null) ){
                             $(".box-etapa1").show();
                        
                        }else if(["acordo","boletoAgrupado","informacoes"].includes(newPayload.context.servicoCDHU) &&  newPayload.context.etapa_cpf === true && newPayload.context.etapa_data === true ){
                        $(".box-etapa2").show();
                        
                        
                        
                        } else if (newPayload.context.etapa_servico === true && !newPayload.context.etapa_data && newPayload.context.CPF &&
                            (newPayload.context.isValidaPosto || !newPayload.context.dateService)) {
                            if (newPayload.context.NomeCar) {
                                $(".box-etapa7").show();
                            } else if (newPayload.context.etapa_posto) {
                                $(".box-etapa1").show();
                            } else {
                                $(".choices").hide();
                                $("#scrollingChatsd").removeClass("boxChoices");
                            }
                        } else if (newPayload.context.etapa_servico === true && newPayload.context.hasOwnProperty('isSolicitacaoCancelarEmAndamento') === false) {
                            $(".box-cancelar").show();
                        } else if (newPayload.context.etapa_nome && newPayload.context.isNomePreenchido && !newPayload.context.etapa_posto) {
                            $(".box-etapa5").show();
                        } else {
                            $(".choices").hide();
                            $("#scrollingChatsd").removeClass("boxChoices");
                        }
                    } else {
                        $(".choices").hide();
                        $("#scrollingChatsd").removeClass("boxChoices");
                    }
                    if (newPayload.context.etapa_servico === false && newPayload.context.hasOwnProperty('isHabilitaBotaoAgendamento') === true) {
                        $("#scrollingChatsd").addClass("boxChoices");
                        $(".choices").show();
                        $(".box-etapa3").show();
                    }

                }
                var messageDivs = buildMessageDomElements(newPayload, isUser);
                var chatBoxElement = document.querySelector(settings.selectors.chatBox);
                var previousLatest = chatBoxElement.querySelectorAll((isUser ? settings.selectors.fromUser : settings.selectors.fromWatson) + settings.selectors.latest);
                if (previousLatest) {
                    Common.listForEach(previousLatest, function (element) {
                        element.classList.remove('latest')
                    })
                }
                
                messageDivs.forEach(function (currentDiv) {
                    chatBoxElement.appendChild(currentDiv);
                    currentDiv.classList.add('loadChatsd');

                    $("#textInput").prop('disabled', !1).focus();
                    $("#textInput").removeClass("loadInput");
                    $("#textInput").attr("placeholder", "Escreva aqui...");
                    $(".message-inner p div .btn-primary").click(function () {
                        $("#textInput").focus()
                        
                    });
                    $(".choices .choices-content .choice").click(function () {
                        $("#textInput").focus()
                        
                    });
                    $(".btn-inicio").click(function () {
                        $(".box-btn-inicial").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".btn-servicos").click(function () {
                        $(".box-btn-servicos").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".btn-horario").click(function () {
                        $(".box-btn-horario").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".btn-confirma").click(function () {
                        $(".box-btn-confirma").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".btn-confirmado").click(function () {
                        $(".box-btn-confirmado").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".box-cancelar").click(function () {
                        $(".choices").hide();
                        $("#scrollingChatsd").removeClass("boxChoices");
                        $(".box-btn-inicial").hide(400);
                        $(".box-btn-horario").hide(400);
                        $(".box-btn-confirma").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                   
                    $(".box-etapa1").click(function () {
                        $(".choices").hide();
                        $("#scrollingChatsd").removeClass("boxChoices");
                        $(".box-btn-inicial").hide(400);
                        $(".box-btn-horario").hide(400);
                        $(".box-btn-confirma").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".box-etapa2").click(function () {
                        $(".choices").hide();
                        $("#scrollingChatsd").removeClass("boxChoices");
                        $(".box-btn-inicial").hide(400);
                        $(".box-btn-horario").hide(400);
                        $(".box-btn-confirma").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".box-etapa3").click(function () {
                        $(".choices").hide();
                        $("#scrollingChatsd").removeClass("boxChoices");
                        $(".box-btn-inicial").hide(400);
                        $(".box-btn-horario").hide(400);
                        $(".box-btn-confirma").hide(400);
                        $("#textInput").prop('disabled', !0).focus();
                        $("#textInput").addClass("loadInput");
                        $("#textInput").attr("placeholder", "")
                    });
                    $(".tipo-horario-m").click(function () {
                        $(".box-horarios-tarde").hide();
                        $(".box-horarios-manha").show();
                        $('#scrollingChatsd').animate({
                            scrollTop: $('#scrollingChatsd')[0].scrollHeight
                        }, 200);
                        $(".tipo-horario-t").removeClass("check");
                        $(".tipo-horario-m").addClass("check")
                    });
                    $(".tipo-horario-t").click(function () {
                        $(".box-horarios-manha").hide();
                        $(".box-horarios-tarde").show();
                        $('#scrollingChatsd').animate({
                            scrollTop: $('#scrollingChatsd')[0].scrollHeight
                        }, 200);
                        $(".tipo-horario-m").removeClass("check");
                        $(".tipo-horario-t").addClass("check")
                    })
                    /**
                     * Hack Botões para IE10 - Alinhamento Vertical Centralizado.
                     */
                    if (document.documentElement.className.trim() === "ie10") {
                        $('.btn-primary').each(function () {
                            if (this.innerText.length <= 14) {
                                $(this).addClass('btn-space');
                            }
                        });
                    }

                });
                if (newPayload.context !== undefined && newPayload.context !== null) scrollToChatBottom() 

                $(chatbotElement).show()
            }
        }

        function isUserMessage(typeValue) {
            if (typeValue === settings.authorTypes.user) {
                return !0
            } else if (typeValue === settings.authorTypes.watson) {
                return !1
            }
            return null
        }

        function buildMessageDomElements(newPayload, isUser) {
            var textArray = isUser ? newPayload.input.text : newPayload.output.text;
            if (Object.prototype.toString.call(textArray) !== '[object Array]') {
                textArray = [textArray]
            }
            var messageArray = [];
            textArray.forEach(function (currentText) {
                if (currentText) {
                    var messageJson = {
                        'tagName': 'div',
                        'classNames': ['segmentsd'],
                        'children': [{
                            'tagName': 'div',
                            'classNames': [(isUser ? 'from-user' : 'from-watson'), 'latest', ((messageArray.length === 0) ? 'top' : 'sub')],
                            'children': [{
                                'tagName': 'div',
                                'classNames': ['message-inner'],
                                'children': [{
                                    'tagName': 'p',
                                    'text': currentText
                                }]
                            }]
                        }]
                    };
                    messageArray.push(Common.buildDomElement(messageJson))
                }
            });
            return messageArray
        }

        function scrollToChatBottom() {
            var scrollingChatsd = document.querySelector('#scrollingChatsd');
            var scrollEl = scrollingChatsd.querySelector(settings.selectors.fromUser + settings.selectors.latest);
            if (scrollEl) {
                scrollingChatsd.scrollTop = scrollEl.offsetTop
            }
            $('#scrollingChatsd').animate({
                scrollTop: $('#scrollingChatsd')[0].scrollHeight
            }, 500)
        }

        function inputKeyDown(event, inputBox) {
            if (event.keyCode === 13 && inputBox.value) {
                var context;
                var latestResponse = Api.getResponsePayload();
                if (latestResponse) {
                    context = latestResponse.context
                }
                Api.sendRequest(inputBox.value, context);
                inputBox.disabled = !0;
                inputBox.classList.add("loadInput");
                inputBox.placeholder = "";
                inputBox.value = '';
                Common.fireEvent(inputBox, 'input');
                $(".box-btn-inicial").hide(400);
                $(".box-btn-horario").hide(400);
                $(".box-btn-confirma").hide(400);
                $(".box-btn-servicos").hide(400);
            }
        }

        function inputClick() {
            var inputText = document.getElementById("textInput");
            if (inputText.value) {
                var context;
                var latestResponse = Api.getResponsePayload();
                if (latestResponse) {
                    context = latestResponse.context
                }
                Api.sendRequest(inputText.value, context);
                inputText.disabled = !0;
                inputText.classList.add("loadInput");
                inputText.placeholder = "";
                inputText.value = '';
                Common.fireEvent(inputText, 'input');
                $(".box-btn-inicial").hide(400);
                $(".box-btn-horario").hide(400);
                $(".box-btn-confirma").hide(400);
                $(".box-btn-servicos").hide(400);
            }
        }
    }());

    /**
     * API GLOBAL.
     */
    (function () {
        ConversationPanel.init()
    })();
    $(document).ready(function () {
        if (/*@cc_on!@*/false) {
            document.documentElement.className += ' ie10';
        }

        $(".bgAjuda").show(200);
        $("#textInput").focus();





        $(".boxChatIcones figure").on((on_dispatch || 'mouseover'), function () {



            $(".chats-column").addClass('bC-On');
            $(".headerBCss").addClass('box-On');
            $("#scrollingChatsd").addClass('box-On');
            $(".inputOutline").addClass('box-On');
            $(".bgAjuda").hide(100);
            $("#textInput").focus();


            $('.thumbBt').hide()

            $('.choices').show();
            if (!($('.box-cancelar').is(':visible')) && (!$('.box-etapa1').is(':visible')) && (!$('.box-etapa2').is(':visible')) && (!$('.box-etapa3').is(':visible'))
                && (!$('.box-etapa4').is(':visible')) && (!$('.box-etapa5').is(':visible')) && (!$('.box-etapa6').is(':visible')) && (!$('.box-etapa7').is(':visible'))) {
                $(".choices").hide();
            }
        });

        $(".closeChat").click(function () {
            $(".chats-column").removeClass('bC-On');
            $(".headerBCss").removeClass('box-On');
            $("#scrollingChatsd").removeClass('box-On');
            $(".inputOutline").removeClass('box-On');
            $(".choices").hide();
            $(".footerBC textarea").val('');
            $(".bgAjuda").show(200);

            if (!$(".thumbBt").is(":visible")) {
                $(".thumbBt").show()
            }
        })
    });
});
